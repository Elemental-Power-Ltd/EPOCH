name: Lint and Test Python

on:
  push:
    branches:
      - "**"

permissions:
  contents: read
  # we need to allow actions to write to save the vcpkg cache
  actions: write

jobs:
  buildepoch:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"
      - name: Install system build prerequisites (with conditional sudo for GH + nektos/act)
        shell: bash
        run: |
            if command -v sudo >/dev/null 2>&1; then SUDO=sudo; else SUDO=; fi
            $SUDO apt-get update
            $SUDO apt-get install -y \
            autoconf automake libtool m4 pkg-config \
            autoconf-archive gawk \
            build-essential \
            linux-libc-dev \
            g++
      - uses: lukka/get-cmake@latest
      - name: Restore vcpkg binary cache
        # workaround for this issue
        # https://github.com/lukka/run-cmake/issues/152
        id: vcpkg-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace }}/vcpkg_cache
          key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: vcpkg-${{ runner.os }}-
      - name: Ensure vcpkg_cache directory exists
        run: mkdir -p ${{ github.workspace }}/vcpkg_cache
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11.5
        with:
          # disable the legacy cache that this action uses
          doNotCache: true
        env:
          VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}/vcpkg_cache,readwrite
          VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg_cache
      - name: Run CMake to make python bindings
        uses: lukka/run-cmake@v10
        env:
          # We need these environmental variables set, even if they aren't actually used (???)
          # otherwise CMake complains
          CMAKE_CXX_COMPILER: g++-14
          CMAKE_MAKE_PROGRAM: make
          ACTIONS_RUNTIME_TOKEN: ${{ github.token }}
          # we need to reiterate the cache settings because run-vcpkg overwrites them
          VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}/vcpkg_cache,readwrite
          VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg_cache
        with:
          cmakeListsTxtPath: '${{ github.workspace }}/epoch_simulator/CMakeLists.txt'
          configurePreset: 'python-linux'
          configurePresetAdditionalArgs: "['-DCMAKE_POSITION_INDEPENDENT_CODE=ON']"
          buildPreset: 'python-rel-linux'
      - name: Upload Python Library
        uses: actions/upload-artifact@v6
        with:
          name: epoch_simulator
          path: epoch_simulator/build/epoch_py/epoch_simulator.cpython-313-x86_64-linux-gnu.so
          overwrite: true
      
      # This mangles the build directory! so do it after uploading the last artefact.
      - name: Run CMake to make test executable
        uses: lukka/run-cmake@v10
        env:
          CMAKE_CXX_COMPILER: /usr/bin/g++-14
          CMAKE_MAKE_PROGRAM: make
          ACTIONS_RUNTIME_TOKEN: ${{ github.token }}
          VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}/vcpkg_cache,readwrite
          VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg_cache
        with:
          cmakeListsTxtPath: '${{ github.workspace }}/CMakeLists.txt'
          configurePreset: 'test-linux'
          buildPreset: 'test-linux'
      - name: Upload Test Executable
        uses: actions/upload-artifact@v6
        with:
          name: epoch_simulator_test
          path: build/epoch_test/epoch_test
          overwrite: true

      - name: Save vcpkg binary cache
        if: steps.vcpkg-cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: ${{ github.workspace }}/vcpkg_cache
          key: ${{ steps.vcpkg-cache-restore.outputs.cache-primary-key }}  
  
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "0.9.27"
        enable-cache: true
    - name: Install ruff
      run: uv add --dev ruff
    - name: Install dependencies
      run: uv sync --locked --all-extras --dev
    - name: Lint with ruff
      run: |
        uv run ruff check . --preview
  
  typecheck_data:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "0.9.27"
        enable-cache: true
    - name: Install mypy
      run: uv add --dev mypy
    - name: Install dependencies
      run: uv sync --locked --all-extras --dev
    - name: Typecheck Data
      working-directory: ./data_service/
      run: |
        uv run mypy --warn-unused-configs --disallow-any-generics  --disallow-untyped-calls --disallow-untyped-defs --disallow-incomplete-defs --check-untyped-defs --disallow-untyped-decorators --warn-redundant-casts --warn-unused-ignores --warn-return-any --no-implicit-reexport --strict-equality --extra-checks --disable-error-code type-arg ./
    - name: Typecheck Optimisation
      working-directory: ./optimisation_service/
      run: |
        uv run mypy --warn-unused-configs --disallow-any-generics  --disallow-untyped-calls --disallow-untyped-defs --disallow-incomplete-defs --check-untyped-defs --disallow-untyped-decorators --warn-redundant-casts --warn-unused-ignores --warn-return-any --no-implicit-reexport --strict-equality --extra-checks --disable-error-code type-arg ./
    - name: Typecheck EPOCH server
      working-directory: ./epoch_server/
      run: |
        uv run mypy --warn-unused-configs --disallow-any-generics  --disallow-untyped-calls --disallow-untyped-defs --disallow-incomplete-defs --check-untyped-defs --disallow-untyped-decorators --warn-redundant-casts --warn-unused-ignores --warn-return-any --no-implicit-reexport --strict-equality --extra-checks --disable-error-code type-arg ./

  typecheck_opt:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "0.9.27"
        enable-cache: true
    - name: Install mypy
      run: uv add --dev mypy
    - name: Install dependencies
      run: uv sync --locked --all-extras --dev
    - name: Typecheck Optimisation
      working-directory: ./optimisation_service/
      run: |
        uv run mypy --warn-unused-configs --disallow-any-generics  --disallow-untyped-calls --disallow-untyped-defs --disallow-incomplete-defs --check-untyped-defs --disallow-untyped-decorators --warn-redundant-casts --warn-unused-ignores --warn-return-any --no-implicit-reexport --strict-equality --extra-checks --disable-error-code type-arg ./

 typecheck_server:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "0.9.27"
        enable-cache: true
    - name: Install mypy
      run: uv add --dev mypy
    - name: Install dependencies
      run: uv sync --locked --all-extras --dev
    - name: Typecheck EPOCH server
      working-directory: ./epoch_server/
      run: |
        uv run mypy --warn-unused-configs --disallow-any-generics  --disallow-untyped-calls --disallow-untyped-defs --disallow-incomplete-defs --check-untyped-defs --disallow-untyped-decorators --warn-redundant-casts --warn-unused-ignores --warn-return-any --no-implicit-reexport --strict-equality --extra-checks --disable-error-code type-arg ./


  run_opt_tests:
    needs: buildepoch
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "0.9.27"
        enable-cache: true
    - name: Install dependencies
      run: uv sync --locked --all-extras --dev
    - name: "Get Epoch simulator artefact"
      uses: actions/download-artifact@v7
      with:
        name: epoch_simulator
        path: ./optimisation_service/
    - name: Install pytest
      run: uv tool install pytest
    - name: Run Pytest
      working-directory: ./optimisation_service/
      run: |
        uv run pytest . -m "not slow"

  test_epoch_simulator:
    needs: buildepoch
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: "Get Epoch simulator artefact"
      uses: actions/download-artifact@v7
      with:
        name: epoch_simulator_test
        path: ./epoch_simulator/epoch_test/
    - name: Run Test
      # For now we set the working-directory to be the test folder
      # this is to allow the tests to read files from this directory
      # (this isn't a good approach and should be fixed)
      working-directory: ./epoch_simulator/epoch_test
      run: ./epoch_simulator/epoch_test/epoch_test
  
  run_data_tests:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version-file: ".python-version"
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "0.9.27"
        enable-cache: true
    - name: Install dependencies
      run: uv sync --locked --all-extras --dev
    - name: Run Pytest
      working-directory: ./data_service/
      run: |
        uv run pytest . -m "not external and not slow" -v

  lint_sql:
      runs-on: ubuntu-latest
      timeout-minutes: 5
      steps:
      - uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.27"
          enable-cache: true
      - name: Install SQLFluff
        run: uv tool install sqlfluff
      - name: Run SQLFluff
        run: uv tool run sqlfluff lint ./data_service/migrations/

  check_migrations:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Check for duplicate migration numbers
        run: |
          up_nums=($(ls ./data_service/migrations/*.up.sql 2>/dev/null | sed 's/_.*//'))
          duplicates=$(printf '%s\n' "${up_nums[@]}" | sort | uniq -d)
          if [ -n "$duplicates" ]; then
            exit 1
          fi

      - name: Check migration counts match
        run: |
          up_count=$(ls ./data_service/migrations/*.up.sql 2>/dev/null | wc -l)
          down_count=$(ls ./data_service/migrations/*.down.sql 2>/dev/null | wc -l)
          if [ "$up_count" -ne "$down_count" ]; then
            exit 1
          fi

      - name: Check each up migration has corresponding down migration
        run: |
          up_nums=($(ls ./data_service/migrations/*.up.sql 2>/dev/null | sed 's/_.*//'))
          down_nums=($(ls ./data_service/migrations/*.down.sql 2>/dev/null | sed 's/_.*//'))
          up_sorted=$(printf '%s\n' "${up_nums[@]}" | sort)
          down_sorted=$(printf '%s\n' "${down_nums[@]}" | sort)
          if [ "$up_sorted" != "$down_sorted" ]; then
            exit 1
          fi

