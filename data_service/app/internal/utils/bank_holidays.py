"""Functions and utils for getting public holiday information in the UK."""

import datetime
from enum import StrEnum

import httpx
from fastapi import HTTPException

# The Government API will only return recent bank holidays,
# so here we store a load of them into the past.

BANK_HOLIDAYS = {
    "england-and-wales": frozenset(
        {
            datetime.date(2012, 1, 2),
            datetime.date(2012, 4, 6),
            datetime.date(2012, 4, 9),
            datetime.date(2012, 5, 7),
            datetime.date(2012, 6, 4),
            datetime.date(2012, 6, 5),
            datetime.date(2012, 8, 27),
            datetime.date(2012, 12, 25),
            datetime.date(2012, 12, 26),
            datetime.date(2013, 1, 1),
            datetime.date(2013, 3, 29),
            datetime.date(2013, 4, 1),
            datetime.date(2013, 5, 6),
            datetime.date(2013, 5, 27),
            datetime.date(2013, 8, 26),
            datetime.date(2013, 12, 25),
            datetime.date(2013, 12, 26),
            datetime.date(2014, 1, 1),
            datetime.date(2014, 4, 18),
            datetime.date(2014, 4, 21),
            datetime.date(2014, 5, 5),
            datetime.date(2014, 5, 26),
            datetime.date(2014, 8, 25),
            datetime.date(2014, 12, 25),
            datetime.date(2014, 12, 26),
            datetime.date(2015, 1, 1),
            datetime.date(2015, 4, 3),
            datetime.date(2015, 4, 6),
            datetime.date(2015, 5, 4),
            datetime.date(2015, 5, 25),
            datetime.date(2015, 8, 31),
            datetime.date(2015, 12, 25),
            datetime.date(2015, 12, 28),
            datetime.date(2016, 1, 1),
            datetime.date(2016, 3, 25),
            datetime.date(2016, 3, 28),
            datetime.date(2016, 5, 2),
            datetime.date(2016, 5, 30),
            datetime.date(2016, 8, 29),
            datetime.date(2016, 12, 26),
            datetime.date(2016, 12, 27),
            datetime.date(2017, 1, 2),
            datetime.date(2017, 4, 14),
            datetime.date(2017, 4, 17),
            datetime.date(2017, 5, 1),
            datetime.date(2017, 5, 29),
            datetime.date(2017, 8, 28),
            datetime.date(2017, 12, 25),
            datetime.date(2017, 12, 26),
            datetime.date(2018, 1, 1),
            datetime.date(2018, 3, 30),
            datetime.date(2018, 4, 2),
            datetime.date(2018, 5, 7),
            datetime.date(2018, 5, 28),
            datetime.date(2018, 8, 27),
            datetime.date(2018, 12, 25),
            datetime.date(2018, 12, 26),
            datetime.date(2019, 1, 1),
            datetime.date(2019, 4, 19),
            datetime.date(2019, 4, 22),
            datetime.date(2019, 5, 6),
            datetime.date(2019, 5, 27),
            datetime.date(2019, 8, 26),
            datetime.date(2019, 12, 25),
            datetime.date(2019, 12, 26),
            datetime.date(2020, 1, 1),
            datetime.date(2020, 4, 10),
            datetime.date(2020, 4, 13),
            datetime.date(2020, 5, 8),
            datetime.date(2020, 5, 25),
            datetime.date(2020, 8, 31),
            datetime.date(2020, 12, 25),
            datetime.date(2020, 12, 28),
            datetime.date(2021, 1, 1),
            datetime.date(2021, 4, 2),
            datetime.date(2021, 4, 5),
            datetime.date(2021, 5, 3),
            datetime.date(2021, 5, 31),
            datetime.date(2021, 8, 30),
            datetime.date(2021, 12, 27),
            datetime.date(2021, 12, 28),
            datetime.date(2022, 1, 3),
            datetime.date(2022, 4, 15),
            datetime.date(2022, 4, 18),
            datetime.date(2022, 5, 2),
            datetime.date(2022, 6, 2),
            datetime.date(2022, 6, 3),
            datetime.date(2022, 8, 29),
            datetime.date(2022, 9, 19),
            datetime.date(2022, 12, 26),
            datetime.date(2022, 12, 27),
            datetime.date(2023, 1, 2),
            datetime.date(2023, 4, 7),
            datetime.date(2023, 4, 10),
            datetime.date(2023, 5, 1),
            datetime.date(2023, 5, 8),
            datetime.date(2023, 5, 29),
            datetime.date(2023, 8, 28),
            datetime.date(2023, 12, 25),
            datetime.date(2023, 12, 26),
            datetime.date(2024, 1, 1),
            datetime.date(2024, 3, 29),
            datetime.date(2024, 4, 1),
            datetime.date(2024, 5, 6),
            datetime.date(2024, 5, 27),
            datetime.date(2024, 8, 26),
            datetime.date(2024, 12, 25),
            datetime.date(2024, 12, 26),
            datetime.date(2025, 1, 1),
            datetime.date(2025, 4, 18),
            datetime.date(2025, 4, 21),
            datetime.date(2025, 5, 5),
            datetime.date(2025, 5, 26),
            datetime.date(2025, 8, 25),
            datetime.date(2025, 12, 25),
            datetime.date(2025, 12, 26),
            datetime.date(2026, 1, 1),
            datetime.date(2026, 4, 3),
            datetime.date(2026, 4, 6),
            datetime.date(2026, 5, 4),
            datetime.date(2026, 5, 25),
            datetime.date(2026, 8, 31),
            datetime.date(2026, 12, 25),
            datetime.date(2026, 12, 28),
            datetime.date(2027, 1, 1),
            datetime.date(2027, 3, 26),
            datetime.date(2027, 3, 29),
            datetime.date(2027, 5, 3),
            datetime.date(2027, 5, 31),
            datetime.date(2027, 8, 30),
            datetime.date(2027, 12, 27),
            datetime.date(2027, 12, 28),
        }
    ),
    "scotland": frozenset(
        {
            datetime.date(2012, 1, 2),
            datetime.date(2012, 1, 3),
            datetime.date(2012, 4, 6),
            datetime.date(2012, 5, 7),
            datetime.date(2012, 6, 4),
            datetime.date(2012, 6, 5),
            datetime.date(2012, 8, 6),
            datetime.date(2012, 11, 30),
            datetime.date(2012, 12, 25),
            datetime.date(2012, 12, 26),
            datetime.date(2013, 1, 1),
            datetime.date(2013, 1, 2),
            datetime.date(2013, 3, 29),
            datetime.date(2013, 5, 6),
            datetime.date(2013, 5, 27),
            datetime.date(2013, 8, 5),
            datetime.date(2013, 12, 2),
            datetime.date(2013, 12, 25),
            datetime.date(2013, 12, 26),
            datetime.date(2014, 1, 1),
            datetime.date(2014, 1, 2),
            datetime.date(2014, 4, 18),
            datetime.date(2014, 5, 5),
            datetime.date(2014, 5, 26),
            datetime.date(2014, 8, 4),
            datetime.date(2014, 12, 1),
            datetime.date(2014, 12, 25),
            datetime.date(2014, 12, 26),
            datetime.date(2015, 1, 1),
            datetime.date(2015, 1, 2),
            datetime.date(2015, 4, 3),
            datetime.date(2015, 5, 4),
            datetime.date(2015, 5, 25),
            datetime.date(2015, 8, 3),
            datetime.date(2015, 11, 30),
            datetime.date(2015, 12, 25),
            datetime.date(2015, 12, 28),
            datetime.date(2016, 1, 1),
            datetime.date(2016, 1, 4),
            datetime.date(2016, 3, 25),
            datetime.date(2016, 5, 2),
            datetime.date(2016, 5, 30),
            datetime.date(2016, 8, 1),
            datetime.date(2016, 11, 30),
            datetime.date(2016, 12, 26),
            datetime.date(2016, 12, 27),
            datetime.date(2017, 1, 2),
            datetime.date(2017, 1, 3),
            datetime.date(2017, 4, 14),
            datetime.date(2017, 5, 1),
            datetime.date(2017, 5, 29),
            datetime.date(2017, 8, 7),
            datetime.date(2017, 11, 30),
            datetime.date(2017, 12, 25),
            datetime.date(2017, 12, 26),
            datetime.date(2018, 1, 1),
            datetime.date(2018, 1, 2),
            datetime.date(2018, 3, 30),
            datetime.date(2018, 5, 7),
            datetime.date(2018, 5, 28),
            datetime.date(2018, 8, 6),
            datetime.date(2018, 11, 30),
            datetime.date(2018, 12, 25),
            datetime.date(2018, 12, 26),
            datetime.date(2019, 1, 1),
            datetime.date(2019, 1, 2),
            datetime.date(2019, 4, 19),
            datetime.date(2019, 5, 6),
            datetime.date(2019, 5, 27),
            datetime.date(2019, 8, 5),
            datetime.date(2019, 12, 2),
            datetime.date(2019, 12, 25),
            datetime.date(2019, 12, 26),
            datetime.date(2020, 1, 1),
            datetime.date(2020, 1, 2),
            datetime.date(2020, 4, 10),
            datetime.date(2020, 5, 8),
            datetime.date(2020, 5, 25),
            datetime.date(2020, 8, 3),
            datetime.date(2020, 11, 30),
            datetime.date(2020, 12, 25),
            datetime.date(2020, 12, 28),
            datetime.date(2021, 1, 1),
            datetime.date(2021, 1, 4),
            datetime.date(2021, 4, 2),
            datetime.date(2021, 5, 3),
            datetime.date(2021, 5, 31),
            datetime.date(2021, 8, 2),
            datetime.date(2021, 11, 30),
            datetime.date(2021, 12, 27),
            datetime.date(2021, 12, 28),
            datetime.date(2022, 1, 3),
            datetime.date(2022, 1, 4),
            datetime.date(2022, 4, 15),
            datetime.date(2022, 5, 2),
            datetime.date(2022, 6, 2),
            datetime.date(2022, 6, 3),
            datetime.date(2022, 8, 1),
            datetime.date(2022, 9, 19),
            datetime.date(2022, 11, 30),
            datetime.date(2022, 12, 26),
            datetime.date(2022, 12, 27),
            datetime.date(2023, 1, 2),
            datetime.date(2023, 1, 3),
            datetime.date(2023, 4, 7),
            datetime.date(2023, 5, 1),
            datetime.date(2023, 5, 8),
            datetime.date(2023, 5, 29),
            datetime.date(2023, 8, 7),
            datetime.date(2023, 11, 30),
            datetime.date(2023, 12, 25),
            datetime.date(2023, 12, 26),
            datetime.date(2024, 1, 1),
            datetime.date(2024, 1, 2),
            datetime.date(2024, 3, 29),
            datetime.date(2024, 5, 6),
            datetime.date(2024, 5, 27),
            datetime.date(2024, 8, 5),
            datetime.date(2024, 12, 2),
            datetime.date(2024, 12, 25),
            datetime.date(2024, 12, 26),
            datetime.date(2025, 1, 1),
            datetime.date(2025, 1, 2),
            datetime.date(2025, 4, 18),
            datetime.date(2025, 5, 5),
            datetime.date(2025, 5, 26),
            datetime.date(2025, 8, 4),
            datetime.date(2025, 12, 1),
            datetime.date(2025, 12, 25),
            datetime.date(2025, 12, 26),
            datetime.date(2026, 1, 1),
            datetime.date(2026, 1, 2),
            datetime.date(2026, 4, 3),
            datetime.date(2026, 5, 4),
            datetime.date(2026, 5, 25),
            datetime.date(2026, 8, 3),
            datetime.date(2026, 11, 30),
            datetime.date(2026, 12, 25),
            datetime.date(2026, 12, 28),
            datetime.date(2027, 1, 1),
            datetime.date(2027, 1, 4),
            datetime.date(2027, 3, 26),
            datetime.date(2027, 5, 3),
            datetime.date(2027, 5, 31),
            datetime.date(2027, 8, 2),
            datetime.date(2027, 11, 30),
            datetime.date(2027, 12, 27),
            datetime.date(2027, 12, 28),
        }
    ),
    "northern-ireland": frozenset(
        {
            datetime.date(2012, 1, 2),
            datetime.date(2012, 3, 19),
            datetime.date(2012, 4, 6),
            datetime.date(2012, 4, 9),
            datetime.date(2012, 5, 7),
            datetime.date(2012, 6, 4),
            datetime.date(2012, 6, 5),
            datetime.date(2012, 7, 12),
            datetime.date(2012, 8, 27),
            datetime.date(2012, 12, 25),
            datetime.date(2012, 12, 26),
            datetime.date(2013, 1, 1),
            datetime.date(2013, 3, 18),
            datetime.date(2013, 3, 29),
            datetime.date(2013, 4, 1),
            datetime.date(2013, 5, 6),
            datetime.date(2013, 5, 27),
            datetime.date(2013, 7, 12),
            datetime.date(2013, 8, 26),
            datetime.date(2013, 12, 25),
            datetime.date(2013, 12, 26),
            datetime.date(2014, 1, 1),
            datetime.date(2014, 3, 17),
            datetime.date(2014, 4, 18),
            datetime.date(2014, 4, 21),
            datetime.date(2014, 5, 5),
            datetime.date(2014, 5, 26),
            datetime.date(2014, 7, 14),
            datetime.date(2014, 8, 25),
            datetime.date(2014, 12, 25),
            datetime.date(2014, 12, 26),
            datetime.date(2015, 1, 1),
            datetime.date(2015, 3, 17),
            datetime.date(2015, 4, 3),
            datetime.date(2015, 4, 6),
            datetime.date(2015, 5, 4),
            datetime.date(2015, 5, 25),
            datetime.date(2015, 7, 13),
            datetime.date(2015, 8, 31),
            datetime.date(2015, 12, 25),
            datetime.date(2015, 12, 28),
            datetime.date(2016, 1, 1),
            datetime.date(2016, 3, 17),
            datetime.date(2016, 3, 25),
            datetime.date(2016, 3, 28),
            datetime.date(2016, 5, 2),
            datetime.date(2016, 5, 30),
            datetime.date(2016, 7, 12),
            datetime.date(2016, 8, 29),
            datetime.date(2016, 12, 26),
            datetime.date(2016, 12, 27),
            datetime.date(2017, 1, 2),
            datetime.date(2017, 3, 17),
            datetime.date(2017, 4, 14),
            datetime.date(2017, 4, 17),
            datetime.date(2017, 5, 1),
            datetime.date(2017, 5, 29),
            datetime.date(2017, 7, 12),
            datetime.date(2017, 8, 28),
            datetime.date(2017, 12, 25),
            datetime.date(2017, 12, 26),
            datetime.date(2018, 1, 1),
            datetime.date(2018, 3, 19),
            datetime.date(2018, 3, 30),
            datetime.date(2018, 4, 2),
            datetime.date(2018, 5, 7),
            datetime.date(2018, 5, 28),
            datetime.date(2018, 7, 12),
            datetime.date(2018, 8, 27),
            datetime.date(2018, 12, 25),
            datetime.date(2018, 12, 26),
            datetime.date(2019, 1, 1),
            datetime.date(2019, 3, 18),
            datetime.date(2019, 4, 19),
            datetime.date(2019, 4, 22),
            datetime.date(2019, 5, 6),
            datetime.date(2019, 5, 27),
            datetime.date(2019, 7, 12),
            datetime.date(2019, 8, 26),
            datetime.date(2019, 12, 25),
            datetime.date(2019, 12, 26),
            datetime.date(2020, 1, 1),
            datetime.date(2020, 3, 17),
            datetime.date(2020, 4, 10),
            datetime.date(2020, 4, 13),
            datetime.date(2020, 5, 8),
            datetime.date(2020, 5, 25),
            datetime.date(2020, 7, 13),
            datetime.date(2020, 8, 31),
            datetime.date(2020, 12, 25),
            datetime.date(2020, 12, 28),
            datetime.date(2021, 1, 1),
            datetime.date(2021, 3, 17),
            datetime.date(2021, 4, 2),
            datetime.date(2021, 4, 5),
            datetime.date(2021, 5, 3),
            datetime.date(2021, 5, 31),
            datetime.date(2021, 7, 12),
            datetime.date(2021, 8, 30),
            datetime.date(2021, 12, 27),
            datetime.date(2021, 12, 28),
            datetime.date(2022, 1, 3),
            datetime.date(2022, 3, 17),
            datetime.date(2022, 4, 15),
            datetime.date(2022, 4, 18),
            datetime.date(2022, 5, 2),
            datetime.date(2022, 6, 2),
            datetime.date(2022, 6, 3),
            datetime.date(2022, 7, 12),
            datetime.date(2022, 8, 29),
            datetime.date(2022, 9, 19),
            datetime.date(2022, 12, 26),
            datetime.date(2022, 12, 27),
            datetime.date(2023, 1, 2),
            datetime.date(2023, 3, 17),
            datetime.date(2023, 4, 7),
            datetime.date(2023, 4, 10),
            datetime.date(2023, 5, 1),
            datetime.date(2023, 5, 8),
            datetime.date(2023, 5, 29),
            datetime.date(2023, 7, 12),
            datetime.date(2023, 8, 28),
            datetime.date(2023, 12, 25),
            datetime.date(2023, 12, 26),
            datetime.date(2024, 1, 1),
            datetime.date(2024, 3, 18),
            datetime.date(2024, 3, 29),
            datetime.date(2024, 4, 1),
            datetime.date(2024, 5, 6),
            datetime.date(2024, 5, 27),
            datetime.date(2024, 7, 12),
            datetime.date(2024, 8, 26),
            datetime.date(2024, 12, 25),
            datetime.date(2024, 12, 26),
            datetime.date(2025, 1, 1),
            datetime.date(2025, 3, 17),
            datetime.date(2025, 4, 18),
            datetime.date(2025, 4, 21),
            datetime.date(2025, 5, 5),
            datetime.date(2025, 5, 26),
            datetime.date(2025, 7, 14),
            datetime.date(2025, 8, 25),
            datetime.date(2025, 12, 25),
            datetime.date(2025, 12, 26),
            datetime.date(2026, 1, 1),
            datetime.date(2026, 3, 17),
            datetime.date(2026, 4, 3),
            datetime.date(2026, 4, 6),
            datetime.date(2026, 5, 4),
            datetime.date(2026, 5, 25),
            datetime.date(2026, 7, 13),
            datetime.date(2026, 8, 31),
            datetime.date(2026, 12, 25),
            datetime.date(2026, 12, 28),
            datetime.date(2027, 1, 1),
            datetime.date(2027, 3, 17),
            datetime.date(2027, 3, 26),
            datetime.date(2027, 3, 29),
            datetime.date(2027, 5, 3),
            datetime.date(2027, 5, 31),
            datetime.date(2027, 7, 12),
            datetime.date(2027, 8, 30),
            datetime.date(2027, 12, 27),
            datetime.date(2027, 12, 28),
        }
    ),
}


class UKCountryEnum(StrEnum):
    """List of countries making up the UK (not Crown Dependencies!)."""

    England = "England"
    Wales = "Wales"
    Scotland = "Scotland"
    NorthernIreland = "NorthernIreland"


async def get_latest_bank_holidays(
    http_client: httpx.AsyncClient, country: UKCountryEnum | str = UKCountryEnum.England
) -> list[datetime.date]:
    """
    Get a list of recent bank holidays for different countries in the UK.

    Bank holidays are published on gov.uk, but vary by country.
    Historical bank holidays aren't always available via that service, so use this if you need to get
    the most recent ones.
    For older bank holidays, use the cached version.
    Fun fact: the Government API also tells you if it's appropriate to put bunting on your website on each day.

    Parameters
    ----------
    http_client
        HTTP client capable of sending a get request
    country
        Which country you're interested in from the UK (may extend in future)

    Returns
    -------
    list[datetime.date]
        List of public holiday dates for that country.
    """
    if country in {UKCountryEnum.England, UKCountryEnum.Wales}:
        key = "england-and-wales"
    elif country == UKCountryEnum.Scotland:
        key = "scotland"
    elif country == UKCountryEnum.NorthernIreland:
        key = "northern-ireland"
    else:
        raise ValueError("Got unknown country for public holidays: " + str(country))

    response = await http_client.get("https://www.gov.uk/bank-holidays.json")
    if response.status_code != 200:
        raise HTTPException(response.status_code, "Could not get bank holiday information from gov.uk")
    data = response.json()[key]["events"]
    return [datetime.datetime.strptime(item["date"], "%Y-%m-%d").replace(tzinfo=datetime.UTC).date() for item in data]


def get_bank_holidays(country: UKCountryEnum = UKCountryEnum.England) -> list[datetime.date]:
    """
    Get a list of bank holidays for different countries in the UK.

    This includes all historical bank holidays, but may not be up-to-date for future ones.

    Parameters
    ----------
    country
        Which country you're interested in from the UK (may extend in future)

    Returns
    -------
    list[datetime.date]
        List of public holiday dates for that country.
    """
    if country in {UKCountryEnum.England, UKCountryEnum.Wales}:
        key = "england-and-wales"
    elif country == UKCountryEnum.Scotland:
        key = "scotland"
    elif country == UKCountryEnum.NorthernIreland:
        key = "northern-ireland"
    else:
        raise ValueError("Got unknown country for public holidays: " + str(country))
    return sorted(BANK_HOLIDAYS[key])
