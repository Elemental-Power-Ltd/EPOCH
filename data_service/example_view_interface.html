<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Heating Load Analysis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
        select, input, button {
            margin: 10px 0;
            padding: 5px;
        }
        #result {
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 600px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Building Heating Load Analysis</h1>
    
    <div id="clientSection">
        <h2>Select Client</h2>
        <select id="clientDropdown" onchange="getSites()"></select>
    </div>

    <div id="siteSection" style="display:none;">
        <h2>Select Site</h2>
        <select id="siteDropdown" onchange="getDatasets()"></select>
    </div>

    <div id="datasetSection" style="display:none;">
        <h2>Select Dataset</h2>
        <select id="datasetDropdown"></select>
        <br>
        <label for="startDate">Start Date:</label>
        <input type="datetime-local" id="startDate">
        <br>
        <label for="endDate">End Date:</label>
        <input type="datetime-local" id="endDate">
        <br>
        <button onclick="getHeatingLoad()">Get Heating Load</button>
    </div>

    <div id="result"></div>

    <script>
        const apiBaseUrl = 'http://localhost:8000'; // Updated to use port 8000

        async function fetchData(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${apiBaseUrl}${endpoint}`, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }

        async function populateDropdown(dropdownId, data, valueKey, textKey) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = '';
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                dropdown.appendChild(option);
            });
        }

        async function getClients() {
            try {
                const clients = await fetchData('/get-clients', 'POST');
                await populateDropdown('clientDropdown', clients, 'client_id', 'name');
                document.getElementById('clientSection').style.display = 'block';
            } catch (error) {
                console.error('Error fetching clients:', error);
            }
        }

        async function getSites() {
            const clientId = document.getElementById('clientDropdown').value;
            try {
                const sites = await fetchData('/get-sites', 'POST', { client_id: clientId });
                await populateDropdown('siteDropdown', sites, 'site_id', 'name');
                document.getElementById('siteSection').style.display = 'block';
            } catch (error) {
                console.error('Error fetching sites:', error);
            }
        }

        async function getDatasets() {
            const siteId = document.getElementById('siteDropdown').value;
            try {
                const datasets = await fetchData('/get-datasets', 'POST', { site_id: siteId });
                await populateDropdown('datasetDropdown', datasets, 'dataset_id', 'dataset_id');
                document.getElementById('datasetSection').style.display = 'block';
            } catch (error) {
                console.error('Error fetching datasets:', error);
            }
        }

        function dateToUTCUnixTimestamp(dateString) {
            const date = new Date(dateString);
            return Math.floor(date.getTime() / 1000);
        }

        async function getHeatingLoad() {
            const datasetId = document.getElementById('datasetDropdown').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const startTs = dateToUTCUnixTimestamp(startDate);
            const endTs = dateToUTCUnixTimestamp(endDate);

            try {
                const heatingLoadData = await fetchData('/get-heating-load', 'POST', {
                    dataset_id: datasetId,
                    start_ts: startTs,
                    end_ts: endTs
                });
                displayHeatingLoad(heatingLoadData);
            } catch (error) {
                console.error('Error fetching heating load:', error);
                document.getElementById('result').innerHTML = 'Error fetching heating load data. Please try again.';
            }
        }

        function displayHeatingLoad(data) {
            const resultDiv = document.getElementById('result');
            let html = '<h2>Heating Load Results</h2>';
            html += '<table>';
            html += '<tr><th>Timestamp</th><th>DHW (kW)</th><th>Heating (kW)</th></tr>';

            data.forEach(item => {
                const date = new Date(item.timestamp); // Convert Unix timestamp to Date object
                const formattedDate = date.toLocaleString(); // Format date for display
                html += `<tr><td>${formattedDate}</td><td>${item.dhw}</td><td>${item.heating}</td></tr>`;
            });

            html += '</table>';
            resultDiv.innerHTML = html;
        }

        // Initialize the page by fetching clients
        getClients();
    </script>
</body>
</html>