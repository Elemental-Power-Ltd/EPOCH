<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulation Demonstrator</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --card: #12141a;
      --muted: #8b93a7;
      --text: #e9edf6;
      --border: #262a36;
      --accent: #6ea8fe;
      --danger: #ff6b6b;
      --ok: #51cf66;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 50% -10%, rgba(110,168,254,.18), transparent 60%),
                  radial-gradient(900px 500px at 0% 20%, rgba(81,207,102,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .container {
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 14px 48px;
    }
    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .header .sub {
      color: var(--muted);
      font-size: 13px;
    }

    details.accordion {
      border: 1px solid var(--border);
      background: rgba(18,20,26,.75);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 10px;
      backdrop-filter: blur(8px);
    }
    details.accordion > summary {
      list-style: none;
      cursor: pointer;
      padding: 12px 14px;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    details.accordion > summary::-webkit-details-marker { display: none; }
    details.accordion > summary .title {
      font-weight: 650;
      letter-spacing: .2px;
    }
    details.accordion > summary .chev {
      position: absolute;
      right: 12px;
      width: 18px;
      height: 18px;
      opacity: .75;
      transition: transform 160ms ease;
    }
    details[open].accordion > summary .chev { transform: rotate(180deg); }

    .content { padding: 0 14px 14px; }

    .hint {
      color: var(--muted);
      font-size: 12px;
      margin: 8px 0 12px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 760px) {
      .row.two { grid-template-columns: 1fr 1fr; }
      .panel-line { grid-template-columns: 1fr 1fr auto; }
      .battery-line { grid-template-columns: 1fr 1fr; }
    }

    .section {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(18,20,26,.60);
      padding: 12px;
    }
    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .section-head .label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 650;
      letter-spacing: .25px;
      text-transform: none;
    }

    .toggle-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .toggle {
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      transition: border-color 140ms ease, background 140ms ease;
      min-width: 120px;
      text-align: center;
    }
    .toggle[aria-pressed="true"] {
      border-color: rgba(110,168,254,.75);
      background: rgba(110,168,254,.14);
    }

    label.field {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="number"], select {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
    }
    input[type="number"]::placeholder { color: rgba(233,237,246,.35); }
    option { background: #11131a; }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: transform 80ms ease, border-color 140ms ease, background 140ms ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border-color: rgba(110,168,254,.45);
      background: rgba(110,168,254,.16);
    }
    .btn.primary:hover { background: rgba(110,168,254,.22); }
    .btn.outline:hover { background: rgba(255,255,255,.08); }

    .icon-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor: pointer;
    }

    .panel-list {
      display: grid;
      gap: 10px;
    }
    .panel-line {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .panel-line:first-child { border-top: none; padding-top: 0; }

    .inline {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 12px;
      font-weight: 650;
    }
    .switch input {
      width: 42px;
      height: 24px;
      appearance: none;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--border);
      border-radius: 999px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 160ms ease, border-color 160ms ease;
    }
    .switch input::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 3px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      transform: translateY(-50%);
      background: rgba(233,237,246,.85);
      transition: transform 160ms ease;
    }
    .switch input:checked {
      background: rgba(81,207,102,.22);
      border-color: rgba(81,207,102,.35);
    }
    .switch input:checked::after { transform: translate(18px, -50%); }

    .results {
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(18,20,26,.75);
      padding: 12px 14px;
    }
    .results h2 {
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: .2px;
      color: var(--muted);
      font-weight: 700;
    }
    .kv {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px) {
      .kv { grid-template-columns: 1fr 1fr; }
    }
    .tile {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    .tile .k {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .tile .v {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
    }
    .status.loading { color: var(--muted); }
    .status.error { color: var(--danger); }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Simulation Demonstrator</h1>
      <div class="sub">Posts to <code>/api/simulate</code> and shows two metrics</div>
    </div>

    <!-- SITE -->
    <details class="accordion" id="siteAccordion" open>
      <summary>
        <span class="title">Site</span>
        <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </summary>
      <div class="content">
        <div class="hint">Choose a type of building and its location.</div>

        <div class="row two">
          <div class="section">
            <div class="section-head">
              <div class="label">Location</div>
            </div>
            <div class="toggle-group" id="locationGroup"></div>
          </div>

          <div class="section">
            <div class="section-head">
              <div class="label">Building</div>
            </div>
            <div class="toggle-group" id="buildingGroup"></div>
          </div>
        </div>
      </div>
    </details>

    <!-- COMPONENTS -->
    <details class="accordion" id="componentsAccordion" open>
      <summary>
        <span class="title">Components</span>
        <svg class="chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </summary>
      <div class="content">
        <div class="hint">Choose the upgrades to make to your site.</div>

        <div class="row" style="gap: 12px;">
          <!-- SOLAR -->
          <div class="section">
            <div class="section-head">
              <div class="label">Solar</div>
              <button class="btn outline" id="addPanelBtn">Add panels</button>
            </div>

            <div id="panelsEmpty" class="hint" style="margin:0;">No panels installed.</div>
            <div class="panel-list" id="panelList" style="margin-top: 10px;"></div>
          </div>

          <!-- HEAT -->
          <div class="section">
            <div class="section-head">
              <div class="label">Heat</div>
            </div>

            <div class="toggle-group" id="heatSourceGroup">
              <button class="toggle" data-value="Boiler" aria-pressed="true">Keep boiler</button>
              <button class="toggle" data-value="HeatPump" aria-pressed="false">Install heat pump</button>
            </div>

            <div id="heatPumpFields" style="margin-top: 10px; display:none;">
              <label class="field" for="heatPower">Heat pump power</label>
              <div class="inline" style="gap: 8px;">
                <input id="heatPower" type="number" min="0" step="0.1" />
                <span class="hint" style="margin:0;">kW</span>
              </div>
            </div>
          </div>

          <!-- BATTERY -->
          <div class="section">
            <div class="section-head">
              <div class="label">Battery</div>
              <label class="switch" title="Toggle battery">
                <span id="batteryOnOff">Off</span>
                <input id="batteryEnabled" type="checkbox" />
              </label>
            </div>

            <div id="batteryEmpty" class="hint" style="margin:0;">No Battery Installed.</div>

            <div id="batteryFields" style="margin-top: 10px; display:none;">
              <div class="row battery-line">
                <div>
                  <label class="field" for="batteryCapacity">Capacity</label>
                  <div class="inline" style="gap: 8px;">
                    <input id="batteryCapacity" type="number" min="0" step="0.1" />
                    <span class="hint" style="margin:0;">kWh</span>
                  </div>
                </div>
                <div>
                  <label class="field" for="batteryPower">Power <span id="batteryPowerAuto" class="hint" style="margin:0;">(auto)</span></label>
                  <div class="inline" style="gap: 8px;">
                    <input id="batteryPower" type="number" min="0" step="0.1" />
                    <span class="hint" style="margin:0;">kW</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- INSULATION -->
          <div class="section">
            <div class="section-head">
              <div class="label">Insulation</div>
            </div>
            <div class="toggle-group" id="insulationGroup">
              <button class="toggle" data-key="double_glazing" aria-pressed="false">Double glazing</button>
              <button class="toggle" data-key="cladding" aria-pressed="false">Cladding</button>
              <button class="toggle" data-key="loft" aria-pressed="false">Loft</button>
            </div>
          </div>
        </div>
      </div>
    </details>

    <div style="margin-top: 10px;">
      <button class="btn primary" id="simulateBtn">Simulate</button>
    </div>

    <div class="results" id="resultsBox" style="display:none;">
      <h2>Result metrics</h2>

      <div class="kv">
        <div class="tile">
          <div class="k">result.metrics.return_on_investment</div>
          <div class="v" id="roiValue">â€”</div>
        </div>
        <div class="tile">
          <div class="k">result.metrics.carbon_balance_scope_1</div>
          <div class="v" id="carbonValue">â€”</div>
        </div>
      </div>

      <div class="status loading" id="loadingLine" style="display:none;">Running simulationâ€¦</div>
      <div class="status error" id="errorLine" style="display:none;"></div>
    </div>
  </div>

  <script>
    // ---- Types (informal) ----
    // SimulationRequest:
    // {
    //   location: "Cardiff"|"London"|"Edinburgh",
    //   building: "Domestic"|"TownHall"|"LeisureCentre",
    //   panels: [{ solar_peak:number, direction:"North"|"East"|"South"|"West" }],
    //   heat: { heat_power:number, heat_source:"Boiler"|"HeatPump" },
    //   insulation: { double_glazing:boolean, cladding:boolean, loft:boolean },
    //   battery: { capacity:number, power:number } | null,
    //   full_reporting: boolean
    // }

    const LOCATIONS = ["Cardiff", "London", "Edinburgh"];
    const BUILDINGS = [
      { value: "Domestic", label: "Domestic" },
      { value: "TownHall", label: "Town hall" },
      { value: "LeisureCentre", label: "Leisure centre" }
    ];
    const DIRECTIONS = ["North", "East", "South", "West"];

    function clampNonNeg(n) {
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, n);
    }

    // ---- State ----
    const state = {
      request: {
        location: "Cardiff",
        building: "Domestic",
        panels: [],
        heat: { heat_power: 8, heat_source: "Boiler" },
        insulation: { double_glazing: false, cladding: false, loft: false },
        battery: null,
        full_reporting: true
      },
      batteryPowerTouched: false,
      loading: false,
      error: null,
      result: null
    };

    // ---- DOM ----
    const el = {
      siteAccordion: document.getElementById("siteAccordion"),
      componentsAccordion: document.getElementById("componentsAccordion"),

      locationGroup: document.getElementById("locationGroup"),
      buildingGroup: document.getElementById("buildingGroup"),

      addPanelBtn: document.getElementById("addPanelBtn"),
      panelsEmpty: document.getElementById("panelsEmpty"),
      panelList: document.getElementById("panelList"),

      heatSourceGroup: document.getElementById("heatSourceGroup"),
      heatPumpFields: document.getElementById("heatPumpFields"),
      heatPower: document.getElementById("heatPower"),

      batteryEnabled: document.getElementById("batteryEnabled"),
      batteryOnOff: document.getElementById("batteryOnOff"),
      batteryEmpty: document.getElementById("batteryEmpty"),
      batteryFields: document.getElementById("batteryFields"),
      batteryCapacity: document.getElementById("batteryCapacity"),
      batteryPower: document.getElementById("batteryPower"),
      batteryPowerAuto: document.getElementById("batteryPowerAuto"),

      insulationGroup: document.getElementById("insulationGroup"),

      simulateBtn: document.getElementById("simulateBtn"),

      resultsBox: document.getElementById("resultsBox"),
      roiValue: document.getElementById("roiValue"),
      carbonValue: document.getElementById("carbonValue"),
      loadingLine: document.getElementById("loadingLine"),
      errorLine: document.getElementById("errorLine")
    };

    // ---- Render helpers ----
    function setToggleGroup(groupEl, currentValue, onChange) {
      [...groupEl.querySelectorAll("button.toggle")].forEach(btn => {
        const v = btn.getAttribute("data-value");
        const pressed = (v === currentValue);
        btn.setAttribute("aria-pressed", pressed ? "true" : "false");
        btn.onclick = () => onChange(v);
      });
    }

    function renderLocationBuilding() {
      el.locationGroup.innerHTML = "";
      LOCATIONS.forEach(loc => {
        const b = document.createElement("button");
        b.className = "toggle";
        b.textContent = loc;
        b.setAttribute("data-value", loc);
        b.setAttribute("aria-pressed", (state.request.location === loc) ? "true" : "false");
        b.onclick = () => {
          state.request.location = loc;
          renderLocationBuilding();
        };
        el.locationGroup.appendChild(b);
      });

      el.buildingGroup.innerHTML = "";
      BUILDINGS.forEach(bld => {
        const b = document.createElement("button");
        b.className = "toggle";
        b.textContent = bld.label;
        b.setAttribute("data-value", bld.value);
        b.setAttribute("aria-pressed", (state.request.building === bld.value) ? "true" : "false");
        b.onclick = () => {
          state.request.building = bld.value;
          renderLocationBuilding();
        };
        el.buildingGroup.appendChild(b);
      });
    }

    function renderPanels() {
      const hasPanels = state.request.panels.length > 0;
      el.panelsEmpty.style.display = hasPanels ? "none" : "block";
      el.addPanelBtn.textContent = hasPanels ? "Add" : "Add panels";

      el.panelList.innerHTML = "";
      state.request.panels.forEach((p, idx) => {
        const row = document.createElement("div");
        row.className = "panel-line";

        const peakWrap = document.createElement("div");
        const peakLabel = document.createElement("label");
        peakLabel.className = "field";
        peakLabel.textContent = "Peak";
        const peakInput = document.createElement("input");
        peakInput.type = "number";
        peakInput.min = "0";
        peakInput.step = "0.1";
        peakInput.value = String(p.solar_peak);
        peakInput.oninput = (e) => {
          const v = clampNonNeg(Number(e.target.value));
          state.request.panels[idx].solar_peak = v;
        };
        peakWrap.appendChild(peakLabel);
        peakWrap.appendChild(peakInput);
        const peakUnit = document.createElement("div");
        peakUnit.className = "hint";
        peakUnit.style.margin = "6px 0 0";
        peakUnit.textContent = "kWp";
        peakWrap.appendChild(peakUnit);

        const dirWrap = document.createElement("div");
        const dirLabel = document.createElement("label");
        dirLabel.className = "field";
        dirLabel.textContent = "Direction";
        const sel = document.createElement("select");
        DIRECTIONS.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          sel.appendChild(opt);
        });
        sel.value = p.direction;
        sel.onchange = (e) => {
          state.request.panels[idx].direction = e.target.value;
        };
        dirWrap.appendChild(dirLabel);
        dirWrap.appendChild(sel);

        const del = document.createElement("button");
        del.className = "icon-btn";
        del.title = "Remove panel";
        del.innerHTML = "ðŸ—‘ï¸";
        del.onclick = () => {
          state.request.panels.splice(idx, 1);
          renderPanels();
        };

        row.appendChild(peakWrap);
        row.appendChild(dirWrap);
        row.appendChild(del);

        el.panelList.appendChild(row);
      });
    }

    function renderHeat() {
      const source = state.request.heat.heat_source;
      setToggleGroup(el.heatSourceGroup, source, (v) => {
        state.request.heat.heat_source = v;
        renderHeat();
      });

      const show = (source === "HeatPump");
      el.heatPumpFields.style.display = show ? "block" : "none";
      el.heatPower.value = String(state.request.heat.heat_power ?? 0);

      el.heatPower.oninput = (e) => {
        state.request.heat.heat_power = clampNonNeg(Number(e.target.value));
      };
    }

    function autoBatteryPowerIfNeeded() {
      if (!state.request.battery) return;
      if (state.batteryPowerTouched) return;

      const cap = clampNonNeg(state.request.battery.capacity);
      const desiredPower = cap / 2;

      if (state.request.battery.power !== desiredPower) {
        state.request.battery.power = desiredPower;
      }
    }

    function renderBattery() {
      const enabled = !!state.request.battery;
      el.batteryEnabled.checked = enabled;
      el.batteryOnOff.textContent = enabled ? "On" : "Off";

      el.batteryEmpty.style.display = enabled ? "none" : "block";
      el.batteryFields.style.display = enabled ? "block" : "none";

      if (!enabled) return;

      autoBatteryPowerIfNeeded();

      el.batteryCapacity.value = String(state.request.battery.capacity);
      el.batteryPower.value = String(state.request.battery.power);

      el.batteryPowerAuto.style.opacity = state.batteryPowerTouched ? "0" : "1";

      el.batteryCapacity.oninput = (e) => {
        const v = clampNonNeg(Number(e.target.value));
        state.request.battery.capacity = v;
        autoBatteryPowerIfNeeded();
        renderBattery(); // refresh power if auto
      };

      el.batteryPower.oninput = (e) => {
        const v = clampNonNeg(Number(e.target.value));
        state.batteryPowerTouched = true;
        state.request.battery.power = v;
        renderBattery();
      };
    }

    function renderInsulation() {
      [...el.insulationGroup.querySelectorAll("button.toggle")].forEach(btn => {
        const key = btn.getAttribute("data-key");
        const selected = !!state.request.insulation[key];
        btn.setAttribute("aria-pressed", selected ? "true" : "false");
        btn.onclick = () => {
          state.request.insulation[key] = !state.request.insulation[key];
          renderInsulation();
        };
      });
    }

    function renderResults() {
      const show = !!state.result || !!state.error || state.loading;
      el.resultsBox.style.display = show ? "block" : "none";

      el.loadingLine.style.display = state.loading ? "block" : "none";
      el.errorLine.style.display = state.error ? "block" : "none";
      el.errorLine.textContent = state.error || "";

      // Display ONLY the two requested fields
      const roi = state.result?.metrics?.return_on_investment;
      const carbon = state.result?.metrics?.carbon_balance_scope_1;

      el.roiValue.textContent = (roi === 0 || roi) ? String(roi) : "â€”";
      el.carbonValue.textContent = (carbon === 0 || carbon) ? String(carbon) : "â€”";
    }

    function renderAll() {
      renderLocationBuilding();
      renderPanels();
      renderHeat();
      renderBattery();
      renderInsulation();
      renderResults();
    }

    // ---- Events ----
    el.addPanelBtn.onclick = () => {
      state.request.panels.push({ solar_peak: 2.5, direction: "South" });
      renderPanels();
    };

    el.batteryEnabled.onchange = (e) => {
      const enabled = e.target.checked;
      state.batteryPowerTouched = false;
      state.request.battery = enabled ? { capacity: 10, power: 5 } : null;
      renderBattery();
    };

    el.simulateBtn.onclick = async () => {
      // match your React demonstrator behaviour:
      state.loading = true;
      state.error = null;
      state.result = null;
      el.siteAccordion.open = false;
      el.componentsAccordion.open = false;
      renderResults();

      try {
        const resp = await fetch("/simulate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(state.request)
        });

        if (!resp.ok) {
          state.loading = false;
          state.error = `Network Error: ${resp.status} ${resp.statusText}`;
          renderResults();
          return;
        }

        const data = await resp.json();
        state.loading = false;
        state.error = null;
        state.result = data;
        renderResults();
      } catch (err) {
        state.loading = false;
        state.result = null;
        state.error = "Invalid Simulation";
        renderResults();
      }
    };

    // ---- Init ----
    renderAll();
  </script>
</body>
</html>
